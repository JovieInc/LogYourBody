name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.filter.outputs.web }}
      ios: ${{ steps.filter.outputs.ios }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            ios:
              - 'apps/ios/**'

  web:
    name: Web
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm typecheck

      - name: Test
        run: pnpm test:ci

      - name: Build
        run: cd apps/web && pnpm build

      - name: Deploy info
        run: |
          echo "## Web Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Vercel deployment handled by Vercel GitHub integration" >> $GITHUB_STEP_SUMMARY

  ios-beta:
    name: iOS Beta
    runs-on: macos-14
    needs: [detect-changes, web]
    if: needs.detect-changes.outputs.ios == 'true' && false  # Enable when ready
    timeout-minutes: 30
    environment:
      name: development
      url: https://testflight.apple.com
    steps:
      - uses: actions/checkout@v4

      - name: Setup iOS build environment
        uses: ./.github/actions/setup-ios-build
        with:
          xcode-version: '16.1'
          working-directory: apps/ios
          setup-ruby: 'true'
          create-config-files: 'true'

      - name: Setup App Store Connect API key
        run: |
          cd apps/ios
          mkdir -p fastlane
          cat > fastlane/api_key.json << 'EOFKEY'
          {
            "key_id": "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}",
            "issuer_id": "${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}",
            "key": "${{ secrets.APP_STORE_CONNECT_API_KEY }}",
            "duration": 1200,
            "in_house": false
          }
          EOFKEY

          echo "APP_STORE_CONNECT_API_KEY_PATH=$(pwd)/fastlane/api_key.json" >> $GITHUB_ENV

      - name: Generate build number
        id: build
        run: |
          BUILD_NUMBER=$(date -u +%Y%m%d%H%M%S)
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Deploy to TestFlight
        run: |
          cd apps/ios
          bundle exec fastlane beta build_number:${{ steps.build.outputs.build_number }}
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_APP_ID: ${{ secrets.APP_STORE_APP_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}

      - name: Cleanup
        if: always()
        run: |
          cd apps/ios
          rm -f fastlane/api_key.json

  deploy-summary:
    name: Deploy Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [detect-changes, web, ios-beta]
    steps:
      - name: Generate summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Web changed: ${{ needs.detect-changes.outputs.web }}" >> $GITHUB_STEP_SUMMARY
          echo "- iOS changed: ${{ needs.detect-changes.outputs.ios }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.web.result }}" == "success" ]]; then
            echo "✅ Web deployment completed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.web.result }}" == "skipped" ]]; then
            echo "⏭️ Web deployment skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.web.result }}" == "failure" ]]; then
            echo "❌ Web deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.ios-beta.result }}" == "success" ]]; then
            echo "✅ iOS deployment completed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.ios-beta.result }}" == "skipped" ]]; then
            echo "⏭️ iOS deployment skipped (disabled or no changes)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.ios-beta.result }}" == "failure" ]]; then
            echo "❌ iOS deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
